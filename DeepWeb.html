<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek静态网站生成工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f1f5f9;
            --gray: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --card-bg: rgba(15, 23, 42, 0.8);
            --card-border: rgba(99, 102, 241, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--darker), #1e293b);
            color: var(--light);
            min-height: 100vh;
            padding: 2rem;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2.5rem;
            padding: 1.5rem;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: inline-block;
            font-weight: 800;
        }

        .subtitle {
            color: var(--gray);
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 32px rgba(2, 6, 23, 0.5);
            backdrop-filter: blur(10px);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.3);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 600;
        }

        .card-title i {
            background: rgba(99, 102, 241, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.8rem 1.2rem;
            border-radius: 12px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            background: rgba(2, 6, 23, 0.5);
            color: var(--light);
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 0.9rem 1.8rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -60%;
            width: 20px;
            height: 200%;
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(25deg);
            transition: all 0.6s;
        }

        .btn:hover::after {
            left: 120%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:disabled::after {
            display: none;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .hidden {
            display: none;
        }

        .output-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(2, 6, 23, 0.6);
            border: 1px solid var(--card-border);
        }

        .output-header {
            padding: 0.8rem 1.2rem;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--card-border);
        }

        .output-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .output-actions {
            display: flex;
            gap: 0.5rem;
        }

        .output-content {
            padding: 1.5rem;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
        }

        #document {
            width: 100%;
            min-height: 280px;
            background: transparent;
            border: none;
            color: var(--light);
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 15px;
        }

        #code {
            white-space: pre-wrap;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.8;
            color: #e2e8f0;
            text-shadow: 0 0 5px rgba(139, 92, 246, 0.5);
        }

        .streaming-indicator {
            display: inline-block;
            margin-left: 10px;
        }

        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            opacity: 0.6;
        }

        .dot:nth-child(1) { animation: pulse 1.5s infinite; }
        .dot:nth-child(2) { animation: pulse 1.5s infinite 0.5s; }
        .dot:nth-child(3) { animation: pulse 1.5s infinite 1s; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.5); opacity: 1; }
        }

        .api-key-container {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .api-key-input {
            display: flex;
            gap: 1rem;
        }

        .api-key-input input {
            flex: 1;
        }

        .note {
            background: rgba(99, 102, 241, 0.1);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin: 1.5rem 0;
            font-size: 0.95rem;
        }

        .tab-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            background: rgba(15, 23, 42, 0.7);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            font-weight: 500;
        }

        .tab.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
            color: var(--primary);
        }

        .progress-bar {
            height: 4px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 1rem;
            position: relative;
        }

        .progress {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        .status-text {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--gray);
            text-align: center;
        }

        .output-section {
            display: none;
        }

        .output-section.active {
            display: block;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .continue-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .continue-title {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            color: var(--warning);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .continue-content {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        .continue-text {
            font-size: 0.95rem;
            color: var(--gray);
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            body {
                padding: 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            h1 {
                font-size: 2.2rem;
            }

            .continue-content {
                grid-template-columns: 1fr;
            }
        }

        /* 错误消息样式 */
        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border-left: 4px solid var(--error);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-magic"></i> DeepSite Creator - AI静态网站生成工具</h1>
            <p class="subtitle">基于DeepSeek的生成完整HTML网站</p>
        </header>

        <main>
            <section class="card">
                <h2 class="card-title"><i class="fas fa-key"></i> API密钥设置</h2>
                <div class="api-key-container">
                    <p><i class="fas fa-exclamation-triangle"></i> 安全提示：请使用临时API密钥，前端直接调用API可能存在安全风险</p>
                    <div class="api-key-input">
                        <input type="password" id="api-key" placeholder="请输入您的DeepSeek API密钥 (格式：sk-xxx)">
                        <button class="btn" id="save-key">
                            <i class="fas fa-save"></i> 保存密钥
                        </button>
                    </div>
                </div>
            </section>

            <section class="card">
                <h2 class="card-title"><i class="fas fa-cog"></i> 网站配置</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="website-type"><i class="fas fa-globe"></i> 网站类型</label>
                        <select id="website-type">
                            <option value="企业官网">企业官网</option>
                            <option value="个人博客">个人博客</option>
                            <option value="电子商务">电子商务</option>
                            <option value="作品集展示">作品集展示</option>
                            <option value="在线教育">在线教育</option>
                            <option value="新闻资讯">新闻资讯</option>
                            <option value="社交网络">社交网络</option>
                            <option value="SAAS服务">SAAS服务</option>
                            <option value="自定义">自定义类型</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="color-scheme"><i class="fas fa-palette"></i> 配色方案</label>
                        <select id="color-scheme">
                            <option value="科技蓝">科技蓝</option>
                            <option value="商务黑金">商务黑金</option>
                            <option value="自然绿色">自然绿色</option>
                            <option value="活力橙红">活力橙红</option>
                            <option value="简约黑白">简约黑白</option>
                            <option value="渐变紫粉">渐变紫粉</option>
                            <option value="自定义">自定义配色</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="layout"><i class="fas fa-layer-group"></i> 布局风格</label>
                        <select id="layout">
                            <option value="单栏简约">单栏简约</option>
                            <option value="双栏响应式">双栏响应式</option>
                            <option value="三栏网格">三栏网格</option>
                            <option value="全屏滚动">全屏滚动</option>
                            <option value="不对称设计">不对称设计</option>
                            <option value="杂志风格">杂志风格</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="components"><i class="fas fa-puzzle-piece"></i> 包含组件</label>
                        <select id="components" multiple>
                            <option value="导航栏" selected>导航栏</option>
                            <option value="轮播图" selected>轮播图</option>
                            <option value="页脚" selected>页脚</option>
                            <option value="联系表单">联系表单</option>
                            <option value="价格表">价格表</option>
                            <option value="时间线">时间线</option>
                            <option value="数据统计">数据统计</option>
                            <option value="团队介绍">团队介绍</option>
                            <option value="客户评价">客户评价</option>
                            <option value="地图集成">地图集成</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="custom-desc"><i class="fas fa-edit"></i> 自定义网站描述</label>
                    <textarea id="custom-desc" placeholder="请详细描述您的网站需求，包括：内容结构、功能需求、特殊效果、目标受众等..."></textarea>
                </div>

                <div class="note">
                    <p><i class="fas fa-lightbulb"></i> 提示：描述越详细，生成的网站越符合您的期望。您可以指定字体、动画效果、交互方式等特殊需求。</p>
                </div>

                <div class="progress-bar hidden" id="doc-progress">
                    <div class="progress" id="doc-progress-bar"></div>
                    <div class="status-text" id="doc-status">正在生成网站文档...</div>
                </div>

                <button class="btn" id="generate-doc">
                    <i class="fas fa-file-alt"></i> 生成网站文档
                </button>
            </section>

            <section class="card hidden" id="doc-section">
                <h2 class="card-title"><i class="fas fa-file-code"></i> 网站设计文档</h2>
                <p>编辑以下文档后点击"生成网站代码"按钮，流式输出过程约需30-60秒</p>

                <div class="output-container">
                    <div class="output-header">
                        <div class="output-title">
                            <i class="fas fa-file-contract"></i>
                            <span>网站设计文档 (可编辑)</span>
                            <div class="streaming-indicator hidden" id="doc-stream-indicator">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </div>
                        </div>
                        <div class="output-actions">
                            <button class="btn btn-outline" id="copy-doc">
                                <i class="far fa-copy"></i> 复制
                            </button>
                        </div>
                    </div>
                    <div class="output-content">
                        <textarea id="document"></textarea>
                    </div>
                </div>

                <div class="progress-bar hidden" id="code-progress">
                    <div class="progress" id="code-progress-bar"></div>
                    <div class="status-text" id="code-status">正在生成网站代码...</div>
                </div>

                <div class="action-buttons">
                    <button class="btn" id="generate-code">
                        <i class="fas fa-code"></i> 生成网站代码
                    </button>
                    <button class="btn btn-outline" id="back-to-edit">
                        <i class="fas fa-edit"></i> 重新编辑需求
                    </button>
                </div>
            </section>

            <section class="card hidden" id="code-section">
                <div class="tab-container">
                    <div class="tab active" data-tab="code">网站代码</div>
                    <div class="tab" data-tab="preview">实时预览</div>
                </div>

                <div class="output-section active" id="code-section-content">
                    <div class="output-container">
                        <div class="output-header">
                            <div class="output-title">
                                <i class="fas fa-code"></i>
                                <span>生成的HTML代码</span>
                                <div class="streaming-indicator hidden" id="code-stream-indicator">
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                </div>
                            </div>
                            <div class="output-actions">
                                <button class="btn btn-outline" id="copy-code">
                                    <i class="far fa-copy"></i> 复制代码
                                </button>
                                <button class="btn" id="preview">
                                    <i class="fas fa-eye"></i> 预览网站
                                </button>
                                <button class="btn" id="download-html">
                                    <i class="fas fa-download"></i> 下载
                                </button>
                            </div>
                        </div>
                        <div class="output-content">
                            <pre id="code"></pre>
                        </div>
                    </div>
                </div>

                <div class="output-section" id="preview-section-content">
                    <div class="output-container">
                        <div class="output-header">
                            <div class="output-title">
                                <i class="fas fa-desktop"></i>
                                <span>网站实时预览</span>
                            </div>
                            <div class="output-actions">
                                <button class="btn" id="open-preview">
                                    <i class="fas fa-external-link-alt"></i> 在新窗口打开
                                </button>
                            </div>
                        </div>
                        <div class="output-content">
                            <div id="preview-frame-container" style="height: 400px; background: #0f172a; border-radius: 8px; overflow: hidden;">
                                <iframe id="preview-frame" style="width: 100%; height: 100%; border: none; background: white;"></iframe>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 续写内容区域 -->
                <div class="continue-section hidden" id="continue-section">
                    <div class="continue-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>内容续写</h3>
                    </div>
                    <div class="continue-content">
                        <div class="continue-text">
                            检测到生成内容可能被截断（达到Token限制）。请点击下方按钮继续生成剩余内容。
                        </div>
                        <button class="btn" id="continue-generating">
                            <i class="fas fa-sync-alt"></i> 继续生成
                        </button>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-outline" id="new-project">
                        <i class="fas fa-plus"></i> 创建新项目
                    </button>
                    <button class="btn" id="regenerate-code">
                        <i class="fas fa-sync-alt"></i> 重新生成代码
                    </button>
                </div>
            </section>
        </main>
    </div>

    <script>
        // 元素引用
        const apiKeyInput = document.getElementById('api-key');
        const saveKeyBtn = document.getElementById('save-key');
        const generateDocBtn = document.getElementById('generate-doc');
        const generateCodeBtn = document.getElementById('generate-code');
        const docSection = document.getElementById('doc-section');
        const codeSection = document.getElementById('code-section');
        const documentTextarea = document.getElementById('document');
        const codePre = document.getElementById('code');
        const docStreamIndicator = document.getElementById('doc-stream-indicator');
        const codeStreamIndicator = document.getElementById('code-stream-indicator');
        const copyDocBtn = document.getElementById('copy-doc');
        const copyCodeBtn = document.getElementById('copy-code');
        const previewBtn = document.getElementById('preview');
        const openPreviewBtn = document.getElementById('open-preview');
        const backToEditBtn = document.getElementById('back-to-edit');
        const newProjectBtn = document.getElementById('new-project');
        const regenerateCodeBtn = document.getElementById('regenerate-code');
        const downloadHtmlBtn = document.getElementById('download-html');
        const tabs = document.querySelectorAll('.tab');
        const outputSections = document.querySelectorAll('.output-section');
        const docProgress = document.getElementById('doc-progress');
        const docProgressBar = document.getElementById('doc-progress-bar');
        const docStatus = document.getElementById('doc-status');
        const codeProgress = document.getElementById('code-progress');
        const codeProgressBar = document.getElementById('code-progress-bar');
        const codeStatus = document.getElementById('code-status');
        const previewFrame = document.getElementById('preview-frame');
        const continueSection = document.getElementById('continue-section');
        const continueGeneratingBtn = document.getElementById('continue-generating');

        // 状态变量
        let currentGenerationType = ''; // 'document' 或 'code'
        let currentPrompt = '';
        let generatedContent = '';
        let isContentTruncated = false;
        let isGenerating = false;
        let retryCount = 0;
        const MAX_RETRIES = 3;
        const MAX_TOKENS = 8192; // 设置最大token限制

        // 保存API密钥
        saveKeyBtn.addEventListener('click', () => {
            if (apiKeyInput.value && apiKeyInput.value.startsWith('sk-')) {
                localStorage.setItem('deepseek-api-key', apiKeyInput.value);
                showNotification('API密钥已保存，刷新页面后仍然有效');
            } else {
                showNotification('请输入有效的API密钥（格式：sk-xxx）', 'error');
            }
        });

        // 页面加载时检查保存的API密钥
        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('deepseek-api-key');
            if (savedKey) {
                apiKeyInput.value = savedKey;
            }
        });

        // 生成网站文档
        generateDocBtn.addEventListener('click', async () => {
            if (isGenerating) return;
            isGenerating = true;

            const apiKey = apiKeyInput.value;
            if (!apiKey || !apiKey.startsWith('sk-')) {
                showNotification('请输入有效的DeepSeek API密钥', 'error');
                isGenerating = false;
                return;
            }

            // 获取表单数据
            const websiteType = document.getElementById('website-type').value;
            const colorScheme = document.getElementById('color-scheme').value;
            const layout = document.getElementById('layout').value;
            const components = [...document.getElementById('components').selectedOptions]
                .map(option => option.value);
            const customDesc = document.getElementById('custom-desc').value || '无';

            // 构建提示词
            currentPrompt = `你是一个专业网站设计师，请根据以下需求创建一个详细的网站设计文档：

## 网站类型
${websiteType}

## 配色方案
${colorScheme}

## 布局风格
${layout}

## 包含组件
${components.join('、')}

## 自定义需求
${customDesc}

## 文档要求
1. 详细描述网站结构和页面布局
2. 定义每个组件的功能和内容要求
3. 指定颜色、字体、间距等设计细节
4. 描述所需的交互效果和动画
5. 规划响应式设计策略
6. 所有图片使用占位图服务：https://via.placeholder.com/ 或 Unsplash 源
7. 输出使用Markdown格式，结构清晰，层次分明`;

            // 设置生成类型
            currentGenerationType = 'document';
            generatedContent = '';
            retryCount = 0;

            // 显示加载状态
            generateDocBtn.disabled = true;
            generateDocBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
            docStreamIndicator.classList.remove('hidden');
            docProgress.classList.remove('hidden');
            documentTextarea.value = '';
            updateProgress(docProgressBar, docStatus, 0, '正在生成网站文档...');

            // 隐藏续写区域
            continueSection.classList.add('hidden');
            isContentTruncated = false;

            try {
                // 调用DeepSeek API（文档生成）
                const finishReason = await streamDeepSeekResponse(currentPrompt, apiKey, 'document');
                docSection.classList.remove('hidden');

                // 检查是否因为长度限制而停止
                if (finishReason === 'length') {
                    showNotification('文档生成可能被截断，请点击"继续生成"按钮完成剩余内容', 'warning');
                    continueSection.classList.remove('hidden');
                    isContentTruncated = true;
                }
            } catch (error) {
                console.error('生成文档时出错:', error);
                showNotification(`生成失败: ${error.message}`, 'error');

                // 重试机制
                if (retryCount < MAX_RETRIES) {
                    retryCount++;
                    showNotification(`尝试重新生成 (${retryCount}/${MAX_RETRIES})...`, 'warning');
                    setTimeout(() => generateDocBtn.click(), 2000);
                    return;
                }
            } finally {
                generateDocBtn.disabled = false;
                generateDocBtn.innerHTML = '<i class="fas fa-file-alt"></i> 生成网站文档';
                docStreamIndicator.classList.add('hidden');
                docProgress.classList.add('hidden');
                isGenerating = false;
            }
        });

        // 生成网站代码
        generateCodeBtn.addEventListener('click', async () => {
            if (isGenerating) return;
            isGenerating = true;

            const apiKey = apiKeyInput.value;
            if (!apiKey || !apiKey.startsWith('sk-')) {
                showNotification('请输入有效的DeepSeek API密钥', 'error');
                isGenerating = false;
                return;
            }

            const documentContent = documentTextarea.value;
            if (!documentContent.trim()) {
                showNotification('请先生成并编辑网站文档', 'warning');
                isGenerating = false;
                return;
            }

            // 构建提示词 - 强调生成完整HTML内容
            currentPrompt = `你是一个专业前端工程师，请根据以下设计文档创建美观大气的HTML页面：

## 设计文档
${documentContent}

## 代码要求
0. 直接输出代码内容，开头结尾不需要多余的语句
1. 使用现代HTML5、CSS3和少量JavaScript
2. 所有图片使用占位图服务使用现成的图网
3. 包含响应式设计，适配移动设备
4. 添加适当的交互效果和动画
5. 使用Flexbox/Grid布局
6. 代码格式规范，注释清晰
7. 包含完整的HTML结构，CSS使用<style>标签内联
8. 页面设计美观大气，符合设计文档要求
9. 输出完整的HTML代码，不要省略任何部分
10. 如果代码太长无法一次完成，请在合适的位置暂停，用户会继续生成剩余部分
11. 确保生成的代码可以直接在浏览器中运行`;

            // 设置生成类型
            currentGenerationType = 'code';
            generatedContent = '';
            retryCount = 0;

            // 显示加载状态
            generateCodeBtn.disabled = true;
            generateCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
            codeStreamIndicator.classList.remove('hidden');
            codeProgress.classList.remove('hidden');
            updateProgress(codeProgressBar, codeStatus, 0, '正在生成网站代码...');
            codePre.textContent = '';

            // 隐藏续写区域
            continueSection.classList.add('hidden');
            isContentTruncated = false;

            try {
                // 切换区域显示
                docSection.classList.add('hidden');
                codeSection.classList.remove('hidden');

                // 调用DeepSeek API（代码生成）
                const finishReason = await streamDeepSeekResponse(currentPrompt, apiKey, 'code');

                // 更新预览
                updatePreview();

                // 检查是否因为长度限制而停止
                if (finishReason === 'length') {
                    showNotification('代码生成可能被截断，请点击"继续生成"按钮完成剩余内容', 'warning');
                    continueSection.classList.remove('hidden');
                    isContentTruncated = true;
                }
            } catch (error) {
                console.error('生成代码时出错:', error);
                showNotification(`生成失败: ${error.message}`, 'error');

                // 重试机制
                if (retryCount < MAX_RETRIES) {
                    retryCount++;
                    showNotification(`尝试重新生成 (${retryCount}/${MAX_RETRIES})...`, 'warning');
                    setTimeout(() => generateCodeBtn.click(), 2000);
                    return;
                }
            } finally {
                generateCodeBtn.disabled = false;
                generateCodeBtn.innerHTML = '<i class="fas fa-code"></i> 生成网站代码';
                codeStreamIndicator.classList.add('hidden');
                codeProgress.classList.add('hidden');
                isGenerating = false;
            }
        });

        // 继续生成按钮点击事件 - 修复覆盖问题
        continueGeneratingBtn.addEventListener('click', async () => {
            if (!isContentTruncated || isGenerating) return;
            isGenerating = true;

            const apiKey = apiKeyInput.value;
            if (!apiKey || !apiKey.startsWith('sk-')) {
                showNotification('请输入有效的DeepSeek API密钥', 'error');
                isGenerating = false;
                return;
            }

            // 准备续写提示 - 将已生成内容作为上下文
            const continuePrompt = `请继续生成HTML代码，从上次中断的地方开始。确保代码风格一致，不要重复之前的内容：

## 已生成内容
${generatedContent}

## 续写要求
1. 继续生成剩余的HTML代码
2. 保持代码风格和格式一致
3. 不要重复已生成的内容
4. 确保最终代码是完整的`;

            // 显示加载状态
            codeStreamIndicator.classList.remove('hidden');
            codeProgress.classList.remove('hidden');
            updateProgress(codeProgressBar, codeStatus, 0, '继续生成代码...');

            continueGeneratingBtn.disabled = true;
            continueGeneratingBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';

            try {
                // 调用DeepSeek API（续写）
                const finishReason = await streamDeepSeekResponse(continuePrompt, apiKey, 'code');

                // 更新预览
                updatePreview();

                // 检查是否还有截断
                if (finishReason === 'length') {
                    showNotification('内容仍未完成，请再次点击"继续生成"', 'warning');
                } else {
                    continueSection.classList.add('hidden');
                    isContentTruncated = false;
                    showNotification('内容生成完成！', 'success');
                }
            } catch (error) {
                console.error('续写时出错:', error);
                showNotification(`续写失败: ${error.message}`, 'error');
            } finally {
                continueGeneratingBtn.disabled = false;
                continueGeneratingBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 继续生成';

                codeStreamIndicator.classList.add('hidden');
                codeProgress.classList.add('hidden');

                isGenerating = false;
            }
        });

        // DeepSeek流式响应处理
        async function streamDeepSeekResponse(prompt, apiKey, target) {
            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages: [{ role: 'user', content: prompt }],
                    stream: true,
                    max_tokens: MAX_TOKENS // 使用最大token限制
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `API请求失败: ${response.status} ${response.statusText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let result = '';
            let receivedChunks = 0;
            const totalChunksEstimate = 100; // 预估的总块数
            let lastFinishReason = null;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                receivedChunks++;
                const progress = Math.min(95, Math.floor((receivedChunks / totalChunksEstimate) * 95));

                if (target === 'document') {
                    updateProgress(docProgressBar, docStatus, progress, '正在生成网站文档...');
                } else {
                    updateProgress(codeProgressBar, codeStatus, progress, '正在生成网站代码...');
                }

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n').filter(line => line.trim() !== '');

                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;

                    const data = line.replace('data: ', '');
                    if (data === '[DONE]') {
                        if (target === 'document') {
                            updateProgress(docProgressBar, docStatus, 100, '文档生成完成！');
                        } else {
                            updateProgress(codeProgressBar, codeStatus, 100, '代码生成完成！');
                        }
                        generatedContent = result;
                        return lastFinishReason;
                    }

                    try {
                        const json = JSON.parse(data);
                        const content = json.choices[0]?.delta?.content || '';
                        const finish_reason = json.choices[0]?.finish_reason || null;

                        if (finish_reason) {
                            lastFinishReason = finish_reason;
                        }

                        if (content) {
                            result += content;

                            if (target === 'document') {
                                documentTextarea.value = result;
                                // 自动滚动到底部
                                documentTextarea.scrollTop = documentTextarea.scrollHeight;
                            } else if (target === 'code') {
                                codePre.textContent = result;
                                // 自动滚动到底部
                                codePre.scrollTop = codePre.scrollHeight;
                            }
                        }
                    } catch (e) {
                        console.error('解析错误:', e);
                    }
                }
            }

            if (target === 'document') {
                updateProgress(docProgressBar, docStatus, 100, '文档生成完成！');
            } else {
                updateProgress(codeProgressBar, codeStatus, 100, '代码生成完成！');
            }

            generatedContent = result;
            return lastFinishReason;
        }

        // 更新进度条
        function updateProgress(progressBar, statusElement, percent, text) {
            progressBar.style.width = `${percent}%`;
            statusElement.textContent = text;

            if (percent === 100) {
                setTimeout(() => {
                    progressBar.style.width = '0';
                }, 1000);
            }
        }

        // 复制文档
        copyDocBtn.addEventListener('click', () => {
            documentTextarea.select();
            document.execCommand('copy');
            showNotification('文档已复制到剪贴板！');
        });

        // 复制代码
        copyCodeBtn.addEventListener('click', () => {
            const textarea = document.createElement('textarea');
            textarea.value = codePre.textContent;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showNotification('代码已复制到剪贴板！');
        });

        // 预览网站
        previewBtn.addEventListener('click', () => {
            updatePreview();
            // 切换到预览标签
            document.querySelector('[data-tab="preview"]').click();
        });

        // 在新窗口打开预览
        openPreviewBtn.addEventListener('click', () => {
            const code = codePre.textContent;
            if (!code.trim()) {
                showNotification('请先生成网站代码', 'warning');
                return;
            }

            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(code);
            previewWindow.document.close();
        });

        // 更新预览
        function updatePreview() {
            const code = codePre.textContent;
            if (!code.trim()) return;

            const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(code);
            iframeDoc.close();
        }

        // 下载HTML文件
        downloadHtmlBtn.addEventListener('click', () => {
            const code = codePre.textContent;
            if (!code.trim()) {
                showNotification('请先生成网站代码', 'warning');
                return;
            }

            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'generated-website.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('HTML文件已下载！');
        });

        // 返回编辑
        backToEditBtn.addEventListener('click', () => {
            docSection.classList.add('hidden');
        });

        // 创建新项目
        newProjectBtn.addEventListener('click', () => {
            if (confirm('确定要开始新项目吗？当前内容将会丢失。')) {
                documentTextarea.value = '';
                codePre.textContent = '';
                document.getElementById('custom-desc').value = '';
                codeSection.classList.add('hidden');
                docSection.classList.add('hidden');
                continueSection.classList.add('hidden');
            }
        });

        // 重新生成代码
        regenerateCodeBtn.addEventListener('click', () => {
            if (confirm('确定要重新生成代码吗？当前生成的代码将会被替换。')) {
                generateCodeBtn.click();
            }
        });

        // 标签切换
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                outputSections.forEach(section => {
                    section.classList.remove('active');
                });

                document.getElementById(`${tabName}-section-content`).classList.add('active');

                if (tabName === 'preview') {
                    updatePreview();
                }
            });
        });

        // 显示通知
        function showNotification(message, type = 'success') {
            // 移除现有通知
            const existingNote = document.querySelector('.notification');
            if (existingNote) existingNote.remove();

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'check-circle'}"></i>
                    ${message}
                </div>
            `;

            document.body.appendChild(notification);

            // 添加动画
            setTimeout(() => {
                notification.style.bottom = '20px';
            }, 10);

            // 3秒后移除
            setTimeout(() => {
                notification.style.bottom = '-100px';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // 添加通知样式
        const style = document.createElement('style');
        style.textContent = `
            .notification {
                position: fixed;
                bottom: -100px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                border-radius: 8px;
                background: var(--card-bg);
                color: white;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                border: 1px solid var(--card-border);
                backdrop-filter: blur(10px);
                z-index: 1000;
                transition: bottom 0.3s ease;
            }

            .notification.success {
                border-left: 4px solid var(--success);
            }

            .notification.error {
                border-left: 4px solid var(--error);
            }

            .notification.warning {
                border-left: 4px solid var(--warning);
            }

            .notification-content {
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 15px;
                font-weight: 500;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
